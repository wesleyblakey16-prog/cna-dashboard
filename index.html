<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>CNA Dashboard (iPad)</title>

<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#2563eb">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<style>
  :root{
    --bg:#f3f4f6; --card:#ffffff; --text:#0f172a; --muted:#64748b; --border:#e5e7eb;
    --danger:#b91c1c; --dangerBg:#fee2e2; --primary:#2563eb; --primaryBg:#dbeafe;
    --shadow: 0 6px 18px rgba(15, 23, 42, 0.08); --radius: 16px;
    --okBg:#ecfdf5; --okBorder:#10b98133; --okText:#065f46;
    --warnBg:#fff7ed; --warnBorder:#fb923c33; --warnText:#9a3412;
  }
  *{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{
    margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
    background:var(--bg); color:var(--text);
  }

  .appHeader{
    position:sticky; top:0; z-index:100;
    background:linear-gradient(to bottom, rgba(243,244,246,0.98), rgba(243,244,246,0.90));
    backdrop-filter: blur(8px);
    padding-top: env(safe-area-inset-top);
    padding:12px 16px;
    border-bottom:1px solid var(--border);
  }
  .headerRow{
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    max-width:1200px; margin:0 auto;
  }
  h1{ margin:0; font-size:22px; }
  .muted{ color:var(--muted); font-size:14px; margin:6px 0 0; }
  .pill{
    display:inline-flex; align-items:center; gap:8px;
    padding:10px 12px; border-radius:999px; background:var(--card);
    border:1px solid var(--border);
    font-size:14px;
  }
  .warnBanner{
    max-width:1200px; margin:10px auto 0;
    background:#fff7ed; border:1px solid #fdba74; color:#9a3412;
    padding:12px 14px; border-radius:14px; font-weight:700;
  }
  .hidden{ display:none; }

  /* Layout */
  .shell{
    max-width:1200px;
    margin: 0 auto;
    padding: 14px 16px calc(24px + env(safe-area-inset-bottom));
    display:grid;
    gap:14px;
    grid-template-columns: 1fr;
  }
  @media (min-width: 820px){
    .shell{ grid-template-columns: 290px 1fr; align-items:start; }
  }

  .card{
    background:var(--card); border:1px solid var(--border);
    border-radius:var(--radius); box-shadow:var(--shadow);
    padding:16px;
  }
  h2,h3{ margin:0 0 12px; font-size:18px; }

  label{ display:block; font-size:14px; color:var(--muted); margin:10px 0 6px; }
  input,select,textarea{
    width:100%; font-size:18px; padding:14px 14px; border-radius:14px;
    border:1px solid var(--border); outline:none; background:#fff;
  }
  textarea{ min-height:96px; resize:vertical; line-height:1.3; }
  input:focus,select:focus,textarea:focus{
    border-color:rgba(37,99,235,0.6);
    box-shadow:0 0 0 4px rgba(37,99,235,0.12);
  }

  .grid{ display:grid; grid-template-columns:1fr; gap:12px; }
  @media (min-width:820px){
    .grid.cols2{ grid-template-columns:repeat(2,1fr); }
    .grid.cols4{ grid-template-columns:repeat(4,1fr); }
  }

  .btnRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
  button{
    -webkit-tap-highlight-color:transparent;
    border:0; border-radius:14px; padding:14px 16px;
    font-size:17px; font-weight:600; cursor:pointer; min-height:52px;
  }
  .btnPrimary{ background:var(--primary); color:#fff; }
  .btnGhost{ background:#fff; border:1px solid var(--border); color:var(--text); }
  .btnDanger{ background:var(--danger); color:#fff; }

  /* Sidebar */
  .sidebar{
    position: sticky;
    top: calc(env(safe-area-inset-top) + 78px);
    z-index: 10;
  }
  .patientList{
    display:flex;
    flex-direction:column;
    gap:10px;
    max-height: calc(100vh - 210px);
    overflow:auto;
    padding-right: 4px;
  }
  .patientItem{
    border:1px solid var(--border);
    border-radius:14px;
    padding:10px 10px;
    background:#fff;
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:10px;
    min-height:60px;
    text-align:left;
  }
  .patientItem.active{
    background: var(--primaryBg);
    border-color: rgba(37,99,235,0.35);
  }
  .patientLeft{
    display:flex;
    flex-direction:column;
    gap:4px;
    min-width:0;
  }
  .patientLeft strong{
    font-size:15px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .patientLeft .sub{
    font-size:12px;
    color:var(--muted);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .nextDue{
    font-size:12px;
    padding:6px 8px;
    border-radius:12px;
    border:1px solid var(--border);
    background:#f8fafc;
    color:var(--muted);
    flex:0 0 auto;
    max-width: 130px;
  }
  .nextDue.ok{ background:var(--okBg); border-color:var(--okBorder); color:var(--okText); }
  .nextDue.warn{ background:var(--warnBg); border-color:var(--warnBorder); color:var(--warnText); }

  .divider{ height:1px; background:var(--border); margin:12px 0; }

  /* Tabs */
  .tabBar{
    position:sticky;
    top: calc(env(safe-area-inset-top) + 78px);
    z-index:50;
    background:rgba(243,244,246,0.95);
    backdrop-filter: blur(8px);
    padding:10px 0;
    margin: -6px 0 12px;
    border-bottom:1px solid var(--border);
  }
  .tabs{ display:flex; gap:10px; overflow-x:auto; padding-bottom:2px; }
  .tabBtn{
    flex:0 0 auto; padding:12px 14px; border-radius:999px;
    border:1px solid var(--border); background:#fff; font-size:16px; min-height:44px;
  }
  .tabBtn.active{ background:var(--primaryBg); border-color:rgba(37,99,235,0.35); color:#1d4ed8; }

  /* Toggle rows */
  .toggleList{ display:grid; gap:10px; }
  .toggle{
    display:flex; align-items:center; justify-content:space-between;
    padding:14px 14px; border-radius:14px; border:1px solid var(--border);
    background:#fff; min-height:56px;
  }
  .toggle .left{ display:flex; flex-direction:column; gap:2px; }
  .toggle .left strong{ font-size:16px; }
  .toggle .left span{ font-size:13px; color:var(--muted); }
  .toggle input[type="checkbox"]{ width:26px; height:26px; accent-color:var(--primary); }

  /* Review table */
  table{ width:100%; border-collapse:collapse; border-radius:14px; overflow:hidden; border:1px solid var(--border); }
  th,td{ padding:10px 10px; border-bottom:1px solid var(--border); vertical-align:top; }
  th{ text-align:left; font-size:13px; color:var(--muted); background:#f8fafc; }
  td{ font-size:14px; }
  tr:last-child td{ border-bottom:0; }

  /* Hourly schedule */
  .hourBlock{
    border:1px solid var(--border);
    border-radius:14px;
    overflow:hidden;
    margin-bottom:12px;
  }
  .hourHeader{
    background:#f8fafc;
    border-bottom:1px solid var(--border);
    padding:10px 12px;
    font-weight:800;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .hourHeader span{ color:var(--muted); font-weight:700; font-size:13px; }
  .hourTasks{ padding:10px 12px; display:grid; gap:10px; }
  .taskRow{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:10px;
    border:1px solid var(--border);
    border-radius:12px;
    padding:10px;
    background:#fff;
  }
  .taskRow .meta{
    min-width:0;
  }
  .taskRow .meta strong{
    display:block;
    font-size:14px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .taskRow .meta small{
    display:block;
    color:var(--muted);
    margin-top:2px;
    font-size:12px;
  }
  .taskRow input[type="checkbox"]{
    width:26px;
    height:26px;
    accent-color: var(--primary);
    margin-top:2px;
    flex: 0 0 auto;
  }

  .toast{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom: calc(16px + env(safe-area-inset-bottom));
    z-index:1000; background:#111827; color:#fff;
    padding:12px 14px; border-radius:999px;
    box-shadow:0 10px 30px rgba(0,0,0,0.2);
    font-size:14px; display:none;
  }
</style>
</head>

<body>
  <div class="appHeader">
    <div class="headerRow">
      <div>
        <h1>CNA Task Dashboard</h1>
        <p class="muted">Next task due on patient tiles • Hour-by-hour schedule view</p>
      </div>
      <div class="pill" id="shiftPill">Shift: Day</div>
    </div>

    <div id="storageWarning" class="warnBanner hidden">
      Storage is blocked in this viewer. Use Safari / installed app for saving to persist.
      You can still use the app right now, but data may not persist after closing.
    </div>
  </div>

  <div class="shell">

    <!-- LEFT SIDEBAR -->
    <div class="sidebar">
      <div class="card">
        <h2>Patients</h2>

        <label>Shift</label>
        <select id="shiftSelect" onchange="setShift(this.value)">
          <option value="day">Day (07–19)</option>
          <option value="night">Night (19–07)</option>
        </select>

        <label>Filter by RN</label>
        <select id="rnFilter" onchange="renderSidebar(); renderHourly();"></select>

        <label>Filter by Room #</label>
        <input id="roomFilter" placeholder="e.g., 214" inputmode="numeric" oninput="renderSidebar(); renderHourly();" />

        <label>Quick select</label>
        <select id="patientSelect" onchange="loadPatient(true)"></select>

        <div class="btnRow" style="margin-top:10px;">
          <button type="button" class="btnGhost" onclick="sortModeToggle()">Sort: <span id="sortModeLabel">Room</span></button>
        </div>

        <div style="margin-top:12px;">
          <div class="patientList" id="patientList"></div>
        </div>

        <div class="divider"></div>

        <h3 style="margin:0 0 12px;">Unit RN List</h3>
        <label>Add RN to list</label>
        <input id="rnAddName" placeholder="e.g., Smith, RN" />
        <div class="btnRow" style="margin-top:10px;">
          <button type="button" class="btnPrimary" onclick="addRN()">Add RN</button>
          <button type="button" class="btnDanger" onclick="clearRNList()">Clear RN List</button>
        </div>
      </div>
    </div>

    <!-- MAIN -->
    <div>
      <!-- Add Patient -->
      <div class="card">
        <h2>Add Patient</h2>

        <div class="grid cols4">
          <div>
            <label>Patient Name</label>
            <input id="patientName" placeholder="e.g., John D." />
          </div>
          <div>
            <label>Room #</label>
            <input id="room" placeholder="e.g., 214" inputmode="numeric" />
          </div>
          <div>
            <label>Bed #</label>
            <input id="bed" placeholder="e.g., A" />
          </div>
          <div>
            <label>Admission Type</label>
            <select id="admissionType">
              <option value="">Select admission type</option>
              <option>Inpatient w/ Telemetry</option>
              <option>Inpatient (No Tele)</option>
              <option>Swing Bed</option>
              <option>Surgical OPIB</option>
            </select>
          </div>
        </div>

        <div class="grid cols2" style="margin-top:10px;">
          <div>
            <label>Primary RN (optional)</label>
            <select id="primaryRNSelect"></select>
          </div>
          <div>
            <label>Or type Primary RN</label>
            <input id="primaryRNText" placeholder="optional if not in list" />
          </div>
        </div>

        <div class="btnRow">
          <button type="button" class="btnPrimary" onclick="addPatient()">Add Patient</button>
          <button type="button" class="btnGhost" onclick="exportJSON()">Export (JSON)</button>
          <button type="button" class="btnGhost" onclick="importJSON()">Import (JSON)</button>
          <button type="button" class="btnDanger" onclick="wipeAll()">Wipe All Data</button>
        </div>
      </div>

      <div id="mainSection" class="hidden">

        <div class="card" style="margin-bottom:14px;">
          <h3>Patient Info</h3>
          <div class="grid cols2">
            <div>
              <label>Assigned Primary RN</label>
              <select id="patientRNSelect" onchange="savePatientRNFromSelect()"></select>
            </div>
            <div>
              <label>Or type Primary RN</label>
              <input id="patientRNText" placeholder="optional override" onblur="savePatientRNFromText()" />
            </div>
          </div>
          <p class="muted" id="patientInfoLine" style="margin-top:10px;">—</p>
        </div>

        <div class="tabBar">
          <div class="tabs">
            <button type="button" class="tabBtn active" id="tabBtn-care" onclick="showTab('care')">Cares</button>
            <button type="button" class="tabBtn" id="tabBtn-tele" onclick="showTab('tele')">Telemetry</button>
            <button type="button" class="tabBtn" id="tabBtn-activity" onclick="showTab('activity')">Activity</button>
            <button type="button" class="tabBtn" id="tabBtn-oral" onclick="showTab('oral')">Oral Care</button>
            <button type="button" class="tabBtn" id="tabBtn-comm" onclick="showTab('comm')">Communication</button>
            <button type="button" class="tabBtn" id="tabBtn-hourly" onclick="showTab('hourly'); renderHourly();">Shift Schedule</button>
            <button type="button" class="tabBtn" id="tabBtn-review" onclick="showTab('review')">Review</button>
          </div>
        </div>

        <!-- CARE -->
        <div id="care" class="card">
          <h3>Patient Cares</h3>

          <div class="toggleList">
            <div class="toggle">
              <div class="left"><strong>Wash face / hands</strong><span>ADLs</span></div>
              <input type="checkbox" id="washFace" />
            </div>
            <div class="toggle">
              <div class="left"><strong>Toileting</strong><span>Assist to bathroom / bedpan</span></div>
              <input type="checkbox" id="toileting" />
            </div>
            <div class="toggle">
              <div class="left"><strong>Ambulation</strong><span>Walking / mobility</span></div>
              <input type="checkbox" id="ambulation" />
            </div>
            <div class="toggle">
              <div class="left"><strong>Primofit / Purewick</strong><span>Incontinence support</span></div>
              <input type="checkbox" id="primofit" />
            </div>
          </div>

          <label>Notes (required)</label>
          <textarea id="careNotes" placeholder="What did you do? Any issues? (Required)"></textarea>

          <div class="btnRow">
            <button type="button" class="btnPrimary" onclick="saveCare()">Save Care</button>
            <button type="button" class="btnGhost" onclick="clearCare()">Clear</button>
          </div>
        </div>

        <!-- TELEMETRY -->
        <div id="tele" class="card hidden">
          <h3>Telemetry</h3>

          <div class="toggleList">
            <div class="toggle">
              <div class="left"><strong>Telemetry battery checked</strong><span>Suggested q2h (reminders appear in schedule)</span></div>
              <input type="checkbox" id="batteryChecked" />
            </div>
          </div>

          <label>Telemetry note (optional)</label>
          <textarea id="teleNotes" placeholder="Optional: any notes on telemetry check"></textarea>

          <div class="divider"></div>

          <div class="toggle">
            <div class="left"><strong>Abnormal event</strong><span>If checked, you can escalate to RN</span></div>
            <input type="checkbox" id="teleAbnormal" onchange="toggleTeleAbnormal()" />
          </div>

          <div id="teleAbnormalSection" class="hidden">
            <label>Abnormal details (required)</label>
            <textarea id="teleAbnormalDetails" placeholder="Describe rhythm/alarm, what happened, what you saw (Required if abnormal)"></textarea>

            <div class="toggle" style="margin-top:10px;">
              <div class="left"><strong>Escalated to RN</strong><span>Optional but recommended if abnormal</span></div>
              <input type="checkbox" id="teleEscalated" onchange="toggleTeleEscalation()" />
            </div>

            <div id="teleEscSection" class="hidden">
              <div class="grid cols2" style="margin-top:10px;">
                <div>
                  <label>RN</label>
                  <select id="teleEscRN"></select>
                </div>
                <div>
                  <label>Escalation details</label>
                  <input id="teleEscDetails" placeholder="what did you report?" />
                </div>
              </div>

              <div class="toggle" style="margin-top:10px;">
                <div class="left"><strong>RN Notified</strong><span>Mark only if you actually notified</span></div>
                <input type="checkbox" id="teleRnNotified" />
              </div>
            </div>
          </div>

          <div class="btnRow">
            <button type="button" class="btnPrimary" onclick="saveTelemetry()">Save Telemetry</button>
            <button type="button" class="btnGhost" onclick="clearTele()">Clear</button>
          </div>
        </div>

        <!-- ACTIVITY -->
        <div id="activity" class="card hidden">
          <h3>Activity / Rounding</h3>
          <div class="toggleList">
            <div class="toggle"><div class="left"><strong>Sleeping</strong><span>Resting</span></div><input type="checkbox" id="sleeping" /></div>
            <div class="toggle"><div class="left"><strong>Awake</strong><span>Alert</span></div><input type="checkbox" id="awake" /></div>
            <div class="toggle"><div class="left"><strong>Visiting with family</strong><span>Family at bedside</span></div><input type="checkbox" id="family" /></div>
            <div class="toggle"><div class="left"><strong>Toileting</strong><span>Needs / used bathroom</span></div><input type="checkbox" id="bathroom" /></div>
          </div>

          <label>Notes (optional)</label>
          <textarea id="activityNotes" placeholder="Optional rounding notes"></textarea>

          <div class="btnRow">
            <button type="button" class="btnPrimary" onclick="saveActivity()">Save Activity</button>
            <button type="button" class="btnGhost" onclick="clearActivity()">Clear</button>
          </div>
        </div>

        <!-- ORAL -->
        <div id="oral" class="card hidden">
          <h3>Oral Care</h3>
          <label>Status (required)</label>
          <select id="oralStatus">
            <option value="">Select</option>
            <option>Completed</option>
            <option>Refused</option>
          </select>

          <label>Notes (optional)</label>
          <textarea id="oralNotes" placeholder="Optional notes"></textarea>

          <div class="btnRow">
            <button type="button" class="btnPrimary" onclick="saveOral()">Save Oral Care</button>
            <button type="button" class="btnGhost" onclick="clearOral()">Clear</button>
          </div>
        </div>

        <!-- COMMUNICATION -->
        <div id="comm" class="card hidden">
          <h3>Communication / Notes</h3>

          <label>Note (required)</label>
          <textarea id="commNote" placeholder="What happened? Who did you talk to? What was the plan? (Required)"></textarea>

          <div class="divider"></div>

          <div class="toggle">
            <div class="left"><strong>Escalated to RN</strong><span>Optional</span></div>
            <input type="checkbox" id="commEscalated" onchange="toggleCommEscalation()" />
          </div>

          <div id="commEscSection" class="hidden">
            <div class="grid cols2" style="margin-top:10px;">
              <div>
                <label>RN</label>
                <select id="commEscRN"></select>
              </div>
              <div>
                <label>Escalation details</label>
                <input id="commEscDetails" placeholder="what did you report / request?" />
              </div>
            </div>

            <div class="toggle" style="margin-top:10px;">
              <div class="left"><strong>RN Notified</strong><span>Mark only if you actually notified</span></div>
              <input type="checkbox" id="commRnNotified" />
            </div>
          </div>

          <div class="btnRow">
            <button type="button" class="btnPrimary" onclick="saveCommunication()">Save Communication</button>
            <button type="button" class="btnGhost" onclick="clearCommunication()">Clear</button>
          </div>
        </div>

        <!-- HOURLY SCHEDULE -->
        <div id="hourly" class="card hidden">
          <h3>Shift Schedule</h3>
          <p class="muted" id="hourlyMeta">—</p>
          <div id="hourlyContainer"></div>
        </div>

        <!-- REVIEW -->
        <div id="review" class="card hidden">
          <h3>Patient Documentation</h3>
          <div class="btnRow" style="margin-top:-2px; margin-bottom:10px;">
            <button type="button" class="btnGhost" onclick="exportPatientCSV()">Export Patient CSV</button>
            <button type="button" class="btnDanger" onclick="clearPatientLogs()">Clear This Patient Logs</button>
          </div>

          <table>
            <thead>
              <tr><th style="width:150px;">Type</th><th>Details</th><th style="width:160px;">Time</th></tr>
            </thead>
            <tbody id="reviewTable"></tbody>
          </table>
        </div>

      </div>
    </div>

  </div>

  <div class="toast" id="toast"></div>

<script>
/* =========================
   Storage + State
========================= */
const STORAGE_KEY = "cna_dashboard_schedule_v1";
let storageOK = false;

let patients = {}; // { [name]: { room, bed, admission, primaryRN, logs: [] } }
let currentPatient = null;

let rnList = [];
let sortMode = "room";

// schedule completion store: { [taskKey]: true }
let completedTasks = {}; // persisted

// shift
let currentShift = "day"; // day/night

/* =========================
   Storage
========================= */
function checkStorage(){
  try{
    const testKey = "__cna_test__";
    localStorage.setItem(testKey, "1");
    localStorage.removeItem(testKey);
    storageOK = true;
  }catch(e){
    storageOK = false;
  }
  document.getElementById("storageWarning").classList.toggle("hidden", storageOK);
}
function saveStore(){
  if(!storageOK) return;
  try{
    localStorage.setItem(STORAGE_KEY, JSON.stringify({
      patients, currentPatient, sortMode, rnList, completedTasks, currentShift
    }));
  }catch(e){
    storageOK = false;
    document.getElementById("storageWarning").classList.remove("hidden");
  }
}
function loadStore(){
  if(!storageOK) return;
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    const parsed = JSON.parse(raw);
    patients = parsed.patients || {};
    currentPatient = parsed.currentPatient || null;
    sortMode = parsed.sortMode || "room";
    rnList = Array.isArray(parsed.rnList) ? parsed.rnList : [];
    completedTasks = parsed.completedTasks || {};
    currentShift = parsed.currentShift || "day";
  }catch(e){}
}

/* =========================
   Utilities
========================= */
function toast(msg){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(window.__toastTimer);
  window.__toastTimer = setTimeout(()=> t.style.display="none", 1600);
}
function requireField(val, msg){
  if(!val || String(val).trim()===""){
    alert(msg);
    return false;
  }
  return true;
}
function escapeHtml(str){
  return String(str || "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function normalizeName(s){
  return String(s || "").trim().replace(/\s+/g, " ");
}
function pad2(n){ return String(n).padStart(2,"0"); }
function toISODate(d){
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
}
function parseTimeHHMM(hhmm){
  const [h,m] = hhmm.split(":").map(x=>parseInt(x,10));
  return { h, m };
}
function buildDateTimeForShift(hhmm){
  // For day shift, times belong to "today" (including 08/12/16 etc)
  // For night shift, 19-23 are today, 00-06 are next day
  const now = new Date();
  const base = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0);
  const { h, m } = parseTimeHHMM(hhmm);
  let d = new Date(base);
  d.setHours(h, m, 0, 0);

  if(currentShift === "night"){
    // if time is after midnight but part of night shift, bump to next day
    if(h < 12) d.setDate(d.getDate() + 1);
    // if time is 19-23 it stays today
  }
  return d;
}
function formatHHMM(d){
  return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}

/* =========================
   Shift
========================= */
function setShift(val){
  currentShift = val;
  document.getElementById("shiftSelect").value = val;
  document.getElementById("shiftPill").textContent = `Shift: ${val === "day" ? "Day" : "Night"}`;
  saveStore();
  renderSidebar();
  renderHourly();
}
function getShiftHours(){
  // Day: 07-18 (12 hours), Night: 19-06 (12 hours)
  if(currentShift === "day"){
    return Array.from({length:12},(_,i)=> pad2(7+i)+":00"); // 07:00..18:00
  }
  // night 19:00..23:00 + 00:00..06:00
  return ["19:00","20:00","21:00","22:00","23:00","00:00","01:00","02:00","03:00","04:00","05:00","06:00"];
}

/* =========================
   RN list + RN filter
========================= */
function buildRNOptionsHTML(includeNone=true){
  let html = "";
  if(includeNone) html += `<option value="">— Select RN —</option>`;
  rnList.forEach(rn => { html += `<option value="${escapeHtml(rn)}">${escapeHtml(rn)}</option>`; });
  return html;
}
function addRN(){
  const raw = document.getElementById("rnAddName").value;
  const name = normalizeName(raw);
  if(!requireField(name, "RN name is required")) return;

  const exists = rnList.some(x => x.toLowerCase() === name.toLowerCase());
  if(!exists) rnList.push(name);
  rnList.sort((a,b)=>a.localeCompare(b));

  document.getElementById("rnAddName").value = "";
  rebuildRNSelects();
  saveStore();
  toast("RN added");
}
function clearRNList(){
  if(!confirm("Clear the Unit RN List?")) return;
  rnList = [];
  rebuildRNSelects();
  saveStore();
  toast("RN list cleared");
}
function buildRNFilterOptions(){
  const sel = document.getElementById("rnFilter");
  if(!sel) return;

  const current = sel.value || "__ALL__";
  const rnSet = new Set(rnList);

  Object.values(patients).forEach(p => {
    if(p && p.primaryRN) rnSet.add(String(p.primaryRN));
  });

  const rns = Array.from(rnSet)
    .map(x => String(x).trim())
    .filter(Boolean)
    .sort((a,b)=>a.localeCompare(b));

  sel.innerHTML = `<option value="__ALL__">All RNs</option>`;
  rns.forEach(rn => {
    sel.innerHTML += `<option value="${escapeHtml(rn)}">${escapeHtml(rn)}</option>`;
  });

  if([...sel.options].some(o => o.value === current)) sel.value = current;
  else sel.value = "__ALL__";
}
function rebuildRNSelects(){
  document.getElementById("primaryRNSelect").innerHTML = buildRNOptionsHTML(true);
  document.getElementById("patientRNSelect").innerHTML = buildRNOptionsHTML(true);
  document.getElementById("teleEscRN").innerHTML = buildRNOptionsHTML(true);
  document.getElementById("commEscRN").innerHTML = buildRNOptionsHTML(true);
  applyPatientRNToUI();
  buildRNFilterOptions();
}

/* =========================
   Tabs
========================= */
function setActiveTab(tab){
  document.querySelectorAll(".tabBtn").forEach(b=>b.classList.remove("active"));
  const btn = document.getElementById("tabBtn-" + tab);
  if(btn) btn.classList.add("active");
}
function showTab(tab){
  ["care","tele","activity","oral","comm","hourly","review"].forEach(id => {
    document.getElementById(id).classList.add("hidden");
  });
  document.getElementById(tab).classList.remove("hidden");
  setActiveTab(tab);
}

/* =========================
   Patient sorting
========================= */
function rebuildPatientSelect(){
  const sel = document.getElementById("patientSelect");
  sel.innerHTML = `<option value="">Select a patient</option>`;
  Object.keys(patients).sort().forEach(name=>{
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    sel.appendChild(opt);
  });
  if(currentPatient && patients[currentPatient]) sel.value = currentPatient;
}
function patientSortKey(name){
  const p = patients[name] || {};
  const roomNum = parseInt(String(p.room||"").replace(/\D+/g,""), 10);
  const roomKey = Number.isFinite(roomNum) ? roomNum : 999999;
  const bedKey = String(p.bed||"").toUpperCase();
  return { roomKey, bedKey, nameKey: name.toUpperCase() };
}
function getSortedPatientNames(){
  const names = Object.keys(patients);
  if(sortMode === "name") return names.sort((a,b)=> a.localeCompare(b));
  return names.sort((a,b)=>{
    const ka = patientSortKey(a), kb = patientSortKey(b);
    if(ka.roomKey !== kb.roomKey) return ka.roomKey - kb.roomKey;
    if(ka.bedKey !== kb.bedKey) return ka.bedKey.localeCompare(kb.bedKey);
    return ka.nameKey.localeCompare(kb.nameKey);
  });
}
function sortModeToggle(){
  sortMode = (sortMode === "room") ? "name" : "room";
  saveStore();
  renderSidebar();
  renderHourly();
  document.getElementById("sortModeLabel").textContent = (sortMode === "room") ? "Room" : "Name";
}

/* =========================
   Task engine
========================= */
function isTeleAdmission(p){ return String(p.admission||"").includes("Telemetry"); }
function isOPIB(p){ return String(p.admission||"").includes("OPIB"); }
function isInpatientNoTele(p){ return String(p.admission||"").includes("No Tele"); }
function isSwingBed(p){ return String(p.admission||"").includes("Swing"); }

function getShiftTaskTimesForPatient(p){
  // Returns list of task instances: { time:"HH:MM", type:"Vitals"/"Tele Battery"/"Oral Care"/"Round", desc:"..." }
  const tasks = [];

  // Vitals schedule based on admission type
  if(isTeleAdmission(p) || isOPIB(p)){
    // q4 vitals
    const times = (currentShift==="day") ? ["08:00","12:00","16:00"] : ["20:00","00:00","04:00"];
    times.forEach(t=>tasks.push({ time:t, type:"Vitals", desc:"Vitals (q4)" }));
    // tele battery q2
    if(isTeleAdmission(p)){
      const bt = (currentShift==="day") ? ["09:00","11:00","13:00","15:00","17:00"] : ["21:00","23:00","01:00","03:00","05:00"];
      bt.forEach(t=>tasks.push({ time:t, type:"Tele Battery", desc:"Check tele battery" }));
    }
  } else if(isInpatientNoTele(p)){
    // q6 vitals
    const times = (currentShift==="day") ? ["08:00","14:00"] : ["20:00","02:00"];
    times.forEach(t=>tasks.push({ time:t, type:"Vitals", desc:"Vitals (q6)" }));
  } else if(isSwingBed(p)){
    // once per shift
    const t = (currentShift==="day") ? "08:00" : "20:00";
    tasks.push({ time:t, type:"Vitals", desc:"Vitals (once/shift)" });
  }

  // Oral care once/shift (can adjust later)
  const oralT = (currentShift==="day") ? "10:00" : "22:00";
  tasks.push({ time: oralT, type:"Oral Care", desc:"Offer oral care" });

  // Hourly round task (lightweight)
  getShiftHours().forEach(hh=>{
    tasks.push({ time: hh, type:"Round", desc:"Hourly round" });
  });

  // sort by time in shift order
  const order = getShiftHours();
  tasks.sort((a,b)=> order.indexOf(a.time) - order.indexOf(b.time));
  return tasks;
}

function getTaskKey(patientName, time, type){
  // Scoped per day+shift so it resets each shift
  const today = toISODate(new Date());
  return `${today}|${currentShift}|${patientName}|${time}|${type}`;
}
function isTaskComplete(patientName, time, type){
  return !!completedTasks[getTaskKey(patientName,time,type)];
}
function setTaskComplete(patientName, time, type, val){
  const k = getTaskKey(patientName,time,type);
  if(val) completedTasks[k] = true;
  else delete completedTasks[k];
  saveStore();
}

function getNextDueForPatient(name){
  const p = patients[name];
  if(!p) return null;

  // apply RN filter / room filter outside; this only computes due
  const instances = getShiftTaskTimesForPatient(p);

  // compute "now" relative to shift
  const now = new Date();

  // find first incomplete task that is at/after now, else earliest incomplete (overdue)
  let upcoming = null;
  let overdue = null;

  for(const inst of instances){
    if(isTaskComplete(name, inst.time, inst.type)) continue;
    const dt = buildDateTimeForShift(inst.time);
    if(dt >= now){
      upcoming = { ...inst, dt };
      break;
    } else {
      if(!overdue) overdue = { ...inst, dt };
    }
  }

  return upcoming || overdue; // can be null if all complete
}

/* =========================
   Sidebar render
========================= */
function renderSidebar(){
  const list = document.getElementById("patientList");
  const roomFilter = document.getElementById("roomFilter").value.trim();
  const rnFilter = document.getElementById("rnFilter").value || "__ALL__";

  const sorted = getSortedPatientNames();
  list.innerHTML = "";

  const filtered = sorted.filter(name=>{
    const p = patients[name] || {};
    const roomOK = !roomFilter ? true : String(p.room||"").includes(roomFilter);
    const assignedRN = String(p.primaryRN || "").trim();
    const rnOK = (rnFilter === "__ALL__") ? true : (assignedRN === rnFilter);
    return roomOK && rnOK;
  });

  if(filtered.length === 0){
    list.innerHTML = `<div class="muted">No patients match the current filters.</div>`;
    return;
  }

  filtered.forEach(name=>{
    const p = patients[name] || {};
    const isActive = (name === currentPatient);

    const next = getNextDueForPatient(name);
    const now = new Date();

    let nextText = "No tasks";
    let cls = "";
    if(next){
      const isOverdue = next.dt < now;
      nextText = `${next.time} • ${next.desc}`;
      cls = isOverdue ? "warn" : "ok";
      // if it's within 30 minutes, make it warn as attention
      if(!isOverdue){
        const mins = Math.round((next.dt - now)/60000);
        if(mins <= 30) cls = "warn";
      }
    } else {
      nextText = "All done";
      cls = "ok";
    }

    const item = document.createElement("button");
    item.type = "button";
    item.className = "patientItem" + (isActive ? " active" : "");
    item.onclick = () => {
      currentPatient = name;
      document.getElementById("patientSelect").value = name;
      loadPatient(false);
      toast(`Switched to ${name}`);
    };

    const rnLine = p.primaryRN ? `RN: ${p.primaryRN}` : "RN: —";

    item.innerHTML = `
      <div class="patientLeft">
        <strong>${escapeHtml(p.room || "—")}${p.bed ? "/" + escapeHtml(p.bed) : ""} — ${escapeHtml(name)}</strong>
        <div class="sub">${escapeHtml(p.admission || "—")} • ${escapeHtml(rnLine)}</div>
      </div>
      <div class="nextDue ${cls}" title="Next task due">${escapeHtml(nextText)}</div>
    `;

    list.appendChild(item);
  });
}

/* =========================
   Hourly schedule render
========================= */
function renderHourly(){
  const container = document.getElementById("hourlyContainer");
  const meta = document.getElementById("hourlyMeta");
  if(!container || !meta) return;

  const rnFilter = document.getElementById("rnFilter").value || "__ALL__";
  const roomFilter = document.getElementById("roomFilter").value.trim();

  const hours = getShiftHours();
  const now = new Date();
  const today = toISODate(new Date());

  meta.textContent = `Date: ${today} • Shift: ${currentShift === "day" ? "Day (07–19)" : "Night (19–07)"} • Showing tasks for selected filters`;

  // choose patients by filters
  const patientNames = getSortedPatientNames().filter(name=>{
    const p = patients[name] || {};
    const roomOK = !roomFilter ? true : String(p.room||"").includes(roomFilter);
    const assignedRN = String(p.primaryRN || "").trim();
    const rnOK = (rnFilter === "__ALL__") ? true : (assignedRN === rnFilter);
    return roomOK && rnOK;
  });

  container.innerHTML = "";

  hours.forEach(hh=>{
    const block = document.createElement("div");
    block.className = "hourBlock";

    const dt = buildDateTimeForShift(hh);
    const isNowHour = (formatHHMM(dt) === formatHHMM(new Date(new Date(dt).setMinutes(0,0,0))));
    const deltaMin = Math.round((dt - now)/60000);

    let suffix = "";
    if(deltaMin < -60) suffix = "Past";
    else if(deltaMin < 0) suffix = "Recently";
    else if(deltaMin === 0) suffix = "Now";
    else suffix = `In ${deltaMin}m`;

    block.innerHTML = `
      <div class="hourHeader">
        <div>${hh}</div>
        <span>${suffix}</span>
      </div>
      <div class="hourTasks" id="tasks-${hh.replace(":","")}"></div>
    `;

    container.appendChild(block);

    const taskWrap = block.querySelector(".hourTasks");

    // tasks due this hour for each patient
    let any = false;
    patientNames.forEach(name=>{
      const p = patients[name];
      if(!p) return;

      const tasks = getShiftTaskTimesForPatient(p).filter(t=>t.time === hh);
      tasks.forEach(t=>{
        any = true;
        const checked = isTaskComplete(name, t.time, t.type);

        const row = document.createElement("div");
        row.className = "taskRow";
        row.innerHTML = `
          <div class="meta">
            <strong>${escapeHtml(name)} (Room ${escapeHtml(p.room || "—")}${p.bed ? "/" + escapeHtml(p.bed) : ""})</strong>
            <small>${escapeHtml(t.desc)} • ${escapeHtml(t.type)}</small>
          </div>
          <input type="checkbox" ${checked ? "checked" : ""} />
        `;

        const cb = row.querySelector("input[type=checkbox]");
        cb.addEventListener("change", () => {
          setTaskComplete(name, t.time, t.type, cb.checked);

          // log completion action (optional)
          logToCurrentPatientIfSelected(name, `Task complete: ${t.time} • ${t.desc} (${t.type})`);

          renderSidebar();
          // keep schedule in sync
          renderHourly();
        });

        taskWrap.appendChild(row);
      });
    });

    if(!any){
      taskWrap.innerHTML = `<div class="muted">No tasks scheduled this hour (with current filters).</div>`;
    }
  });
}

function logToCurrentPatientIfSelected(name, detail){
  // Only auto-log if the patient is currently selected (keeps logs clean)
  if(currentPatient !== name) return;
  logToCurrentPatient("Task", detail);
}

/* =========================
   Patient RN assignment
========================= */
function applyPatientRNToUI(){
  if(!currentPatient || !patients[currentPatient]) return;
  const p = patients[currentPatient];
  const assigned = p.primaryRN || "";
  document.getElementById("patientRNSelect").value = rnList.includes(assigned) ? assigned : "";
  document.getElementById("patientRNText").value = rnList.includes(assigned) ? "" : assigned;
}
function savePatientRNFromSelect(){
  if(!currentPatient || !patients[currentPatient]) return;
  const val = document.getElementById("patientRNSelect").value;
  if(val){
    patients[currentPatient].primaryRN = val;
    document.getElementById("patientRNText").value = "";
    rebuildRNSelects();
    saveStore();
    renderSidebar();
    renderHourly();
    updateHeaderMeta();
    toast("Primary RN assigned");
  }
}
function savePatientRNFromText(){
  if(!currentPatient || !patients[currentPatient]) return;
  const val = normalizeName(document.getElementById("patientRNText").value);
  if(val){
    patients[currentPatient].primaryRN = val;
    document.getElementById("patientRNSelect").value = "";
    rebuildRNSelects();
    saveStore();
    renderSidebar();
    renderHourly();
    updateHeaderMeta();
    toast("Primary RN assigned");
  }
}

/* =========================
   Patient load + header
========================= */
function updateHeaderMeta(){
  const pill = document.getElementById("shiftPill");
  pill.textContent = `Shift: ${currentShift === "day" ? "Day" : "Night"}`;

  const info = document.getElementById("patientInfoLine");
  const sel = document.getElementById("pillPatient"); // not used now

  if(!currentPatient || !patients[currentPatient]){
    info.textContent = "—";
    return;
  }
  const p = patients[currentPatient];
  info.textContent =
    `Room/Bed: ${p.room || "—"} / ${p.bed || "—"} • Admission: ${p.admission || "—"} • Primary RN: ${p.primaryRN || "—"} • Logs: ${(p.logs||[]).length}`;
}

function addPatient(){
  const name = document.getElementById("patientName").value.trim();
  const room = document.getElementById("room").value.trim();
  const bed  = document.getElementById("bed").value.trim();
  const admission = document.getElementById("admissionType").value;

  if(!requireField(name, "Patient name is required")) return;
  if(!requireField(room, "Room # is required")) return;
  if(!requireField(bed, "Bed # is required")) return;
  if(!requireField(admission, "Admission type is required")) return;

  const rnFromSelect = document.getElementById("primaryRNSelect").value;
  const rnFromText = normalizeName(document.getElementById("primaryRNText").value);
  const chosenRN = rnFromSelect || rnFromText || "";

  patients[name] = patients[name] || { logs: [] };
  patients[name].room = room;
  patients[name].bed = bed;
  patients[name].admission = admission;
  patients[name].primaryRN = chosenRN;
  if(!Array.isArray(patients[name].logs)) patients[name].logs = [];

  currentPatient = name;

  document.getElementById("patientName").value = "";
  document.getElementById("room").value = "";
  document.getElementById("bed").value = "";
  document.getElementById("admissionType").value = "";
  document.getElementById("primaryRNSelect").value = "";
  document.getElementById("primaryRNText").value = "";

  rebuildPatientSelect();
  rebuildRNSelects();
  buildRNFilterOptions();
  renderSidebar();
  renderHourly();
  loadPatient(true);
  saveStore();
  toast("Patient saved");
}

function loadPatient(forceShow){
  const selVal = document.getElementById("patientSelect").value;
  if(selVal) currentPatient = selVal;

  if(!currentPatient || !patients[currentPatient]){
    document.getElementById("mainSection").classList.add("hidden");
    updateHeaderMeta();
    saveStore();
    renderSidebar();
    renderHourly();
    return;
  }

  const p = patients[currentPatient];
  if(!Array.isArray(p.logs)) p.logs = [];

  document.getElementById("mainSection").classList.remove("hidden");
  rebuildRNSelects();
  applyPatientRNToUI();
  refreshReview();
  buildRNFilterOptions();
  renderSidebar();
  renderHourly();
  updateHeaderMeta();

  // reset tele abnormal UI
  clearTele(false);

  if(forceShow) showTab("care");
  saveStore();
}

/* =========================
   Logging
========================= */
function logToCurrentPatient(type, details){
  if(!currentPatient || !patients[currentPatient]) return;
  const p = patients[currentPatient];
  if(!Array.isArray(p.logs)) p.logs = [];
  p.logs.push({ type, details, time: new Date().toLocaleString() });

  saveStore();
  refreshReview();
  updateHeaderMeta();
}

/* =========================
   Review table
========================= */
function refreshReview(){
  const tbody = document.getElementById("reviewTable");
  tbody.innerHTML = "";
  if(!currentPatient || !patients[currentPatient]) return;

  const logs = (patients[currentPatient].logs || []);
  if(logs.length === 0){
    tbody.innerHTML = `<tr><td colspan="3" class="muted">No documentation yet for this patient.</td></tr>`;
    return;
  }

  [...logs].reverse().forEach(l=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><strong>${escapeHtml(l.type)}</strong></td>
      <td>${escapeHtml(l.details)}</td>
      <td>${escapeHtml(l.time)}</td>`;
    tbody.appendChild(tr);
  });
}

/* =========================
   Care
========================= */
function saveCare(){
  const notes = document.getElementById("careNotes").value.trim();
  if(!requireField(notes, "Care notes are required")) return;

  const tasks = [];
  if(document.getElementById("washFace").checked) tasks.push("Washed face/hands");
  if(document.getElementById("toileting").checked) tasks.push("Toileting");
  if(document.getElementById("ambulation").checked) tasks.push("Ambulated");
  if(document.getElementById("primofit").checked) tasks.push("Primofit/Purewick");

  const detail = `${tasks.length ? tasks.join(", ") : "No boxes checked"} — Notes: ${notes}`;
  logToCurrentPatient("Care", detail);

  clearCare(false);
  toast("Saved");
}
function clearCare(clearNotes=true){
  document.getElementById("washFace").checked = false;
  document.getElementById("toileting").checked = false;
  document.getElementById("ambulation").checked = false;
  document.getElementById("primofit").checked = false;
  if(clearNotes) document.getElementById("careNotes").value = "";
}

/* =========================
   Telemetry (abnormal triggers escalation only)
========================= */
function toggleTeleAbnormal(){
  const on = document.getElementById("teleAbnormal").checked;
  document.getElementById("teleAbnormalSection").classList.toggle("hidden", !on);
  if(!on){
    document.getElementById("teleEscalated").checked = false;
    document.getElementById("teleEscSection").classList.add("hidden");
    document.getElementById("teleAbnormalDetails").value = "";
    document.getElementById("teleEscDetails").value = "";
    document.getElementById("teleRnNotified").checked = false;
  }
}
function toggleTeleEscalation(){
  const on = document.getElementById("teleEscalated").checked;
  document.getElementById("teleEscSection").classList.toggle("hidden", !on);
  // default to patient RN if present
  if(on && currentPatient && patients[currentPatient]){
    const assigned = patients[currentPatient].primaryRN || "";
    if(assigned && rnList.includes(assigned) && document.getElementById("teleEscRN").value === ""){
      document.getElementById("teleEscRN").value = assigned;
    }
  }
}
function saveTelemetry(){
  const battery = document.getElementById("batteryChecked").checked;
  const note = document.getElementById("teleNotes").value.trim();

  // If battery checked, mark the corresponding q2h task complete for the current hour block if it exists
  // We'll mark the nearest current-hour tele battery task for this patient (if scheduled) complete.
  if(currentPatient && patients[currentPatient] && battery){
    const now = new Date();
    const hh = `${pad2(now.getHours())}:00`;
    // if this hour is in the shift hours and task exists
    const shiftHours = getShiftHours();
    if(shiftHours.includes(hh)){
      setTaskComplete(currentPatient, hh, "Tele Battery", true);
    }
  }

  let detail = "";
  if(battery) detail += "Tele battery checked. ";
  if(note) detail += `Note: ${note}`;

  const abnormal = document.getElementById("teleAbnormal").checked;
  if(abnormal){
    const ab = document.getElementById("teleAbnormalDetails").value.trim();
    if(!requireField(ab, "Abnormal details are required if abnormal event is checked")) return;

    detail += (detail ? " | " : "") + `ABNORMAL: ${ab}`;

    const escalated = document.getElementById("teleEscalated").checked;
    if(escalated){
      const rn = document.getElementById("teleEscRN").value || "(RN not selected)";
      const esc = document.getElementById("teleEscDetails").value.trim() || "(no escalation details)";
      const notified = document.getElementById("teleRnNotified").checked ? "YES" : "NO";
      detail += ` | ESCALATED: To ${rn} • Details: ${esc} • RN Notified: ${notified}`;
    }
  }

  if(!detail) detail = "Telemetry checked (no additional notes).";

  logToCurrentPatient("Telemetry", detail);
  renderSidebar();
  renderHourly();
  refreshReview();
  toast("Saved");
  clearTele(false);
}
function clearTele(clearNotes=true){
  document.getElementById("batteryChecked").checked = false;
  if(clearNotes) document.getElementById("teleNotes").value = "";
  document.getElementById("teleAbnormal").checked = false;
  document.getElementById("teleAbnormalSection").classList.add("hidden");
  document.getElementById("teleAbnormalDetails").value = "";
  document.getElementById("teleEscalated").checked = false;
  document.getElementById("teleEscSection").classList.add("hidden");
  document.getElementById("teleEscDetails").value = "";
  document.getElementById("teleRnNotified").checked = false;
  document.getElementById("teleEscRN").value = "";
}

/* =========================
   Activity / Oral / Communication
========================= */
function saveActivity(){
  const tasks = [];
  if(document.getElementById("sleeping").checked) tasks.push("Sleeping");
  if(document.getElementById("awake").checked) tasks.push("Awake");
  if(document.getElementById("family").checked) tasks.push("Visiting with family");
  if(document.getElementById("bathroom").checked) tasks.push("Toileting");

  const notes = document.getElementById("activityNotes").value.trim();
  const detail = `${tasks.length ? tasks.join(", ") : "No boxes checked"}${notes ? " — Notes: " + notes : ""}`;
  logToCurrentPatient("Activity", detail);
  clearActivity(false);
  toast("Saved");
}
function clearActivity(clearNotes=true){
  document.getElementById("sleeping").checked = false;
  document.getElementById("awake").checked = false;
  document.getElementById("family").checked = false;
  document.getElementById("bathroom").checked = false;
  if(clearNotes) document.getElementById("activityNotes").value = "";
}

function saveOral(){
  const status = document.getElementById("oralStatus").value;
  if(!requireField(status, "Oral care status is required")) return;
  const notes = document.getElementById("oralNotes").value.trim();
  logToCurrentPatient("Oral Care", `${status}${notes ? " — Notes: " + notes : ""}`);

  // mark oral care scheduled task complete for its scheduled time
  if(currentPatient && patients[currentPatient]){
    const t = (currentShift==="day") ? "10:00" : "22:00";
    setTaskComplete(currentPatient, t, "Oral Care", true);
  }

  renderSidebar();
  renderHourly();
  clearOral(false);
  toast("Saved");
}
function clearOral(clearNotes=true){
  document.getElementById("oralStatus").value = "";
  if(clearNotes) document.getElementById("oralNotes").value = "";
}

function toggleCommEscalation(){
  const on = document.getElementById("commEscalated").checked;
  document.getElementById("commEscSection").classList.toggle("hidden", !on);
  if(on && currentPatient && patients[currentPatient]){
    const assigned = patients[currentPatient].primaryRN || "";
    if(assigned && rnList.includes(assigned) && document.getElementById("commEscRN").value === ""){
      document.getElementById("commEscRN").value = assigned;
    }
  }
}
function saveCommunication(){
  const note = document.getElementById("commNote").value.trim();
  if(!requireField(note, "Communication note is required")) return;

  let detail = `Note: ${note}`;

  const esc = document.getElementById("commEscalated").checked;
  if(esc){
    const rn = document.getElementById("commEscRN").value || "(RN not selected)";
    const escD = document.getElementById("commEscDetails").value.trim() || "(no escalation details)";
    const notified = document.getElementById("commRnNotified").checked ? "YES" : "NO";
    detail += ` | ESCALATED: To ${rn} • Details: ${escD} • RN Notified: ${notified}`;
  }

  logToCurrentPatient("Communication", detail);
  clearCommunication(false);
  toast("Saved");
}
function clearCommunication(clearNote=true){
  if(clearNote) document.getElementById("commNote").value = "";
  document.getElementById("commEscalated").checked = false;
  document.getElementById("commEscSection").classList.add("hidden");
  document.getElementById("commEscRN").value = "";
  document.getElementById("commEscDetails").value = "";
  document.getElementById("commRnNotified").checked = false;
}

/* =========================
   Exports / Wipe
========================= */
function downloadFile(filename, content, mime){
  const blob = new Blob([content], { type: mime || "text/plain" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
function exportJSON(){
  const payload = JSON.stringify({ patients, currentPatient, sortMode, rnList, completedTasks, currentShift }, null, 2);
  downloadFile("cna_dashboard_backup.json", payload, "application/json");
}
function importJSON(){
  const inp = document.createElement("input");
  inp.type = "file";
  inp.accept = "application/json";
  inp.onchange = () => {
    const file = inp.files && inp.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const parsed = JSON.parse(reader.result);
        patients = parsed.patients || {};
        currentPatient = parsed.currentPatient || null;
        sortMode = parsed.sortMode || "room";
        rnList = Array.isArray(parsed.rnList) ? parsed.rnList : [];
        completedTasks = parsed.completedTasks || {};
        currentShift = parsed.currentShift || "day";

        setShift(currentShift);
        rebuildPatientSelect();
        rebuildRNSelects();
        buildRNFilterOptions();
        renderSidebar();
        renderHourly();
        loadPatient(true);
        toast("Imported");
      }catch(e){
        alert("Import failed: invalid JSON.");
      }
    };
    reader.readAsText(file);
  };
  inp.click();
}
function wipeAll(){
  if(!confirm("Wipe ALL patients, logs, and task checkoffs? This cannot be undone.")) return;
  patients = {};
  currentPatient = null;
  rnList = [];
  completedTasks = {};
  try{ localStorage.removeItem(STORAGE_KEY); }catch(e){}
  rebuildPatientSelect();
  rebuildRNSelects();
  buildRNFilterOptions();
  renderSidebar();
  renderHourly();
  loadPatient(true);
  toast("Wiped");
}
function clearPatientLogs(){
  if(!currentPatient) return;
  if(!confirm(`Clear ALL logs for ${currentPatient}?`)) return;
  patients[currentPatient].logs = [];
  saveStore();
  refreshReview();
  updateHeaderMeta();
  toast("Cleared logs");
}
function exportPatientCSV(){
  if(!currentPatient || !patients[currentPatient]) return alert("Select a patient first.");
  const p = patients[currentPatient];
  const rows = [["Patient","Room","Bed","Admission","PrimaryRN","Type","Details","Time"]];
  (p.logs||[]).forEach(l=>{
    rows.push([currentPatient,p.room,p.bed,p.admission,p.primaryRN||"",l.type,l.details,l.time]);
  });
  const csv = rows.map(r => r.map(v => {
    const s = String(v ?? "");
    return /[",\n]/.test(s) ? `"${s.replaceAll('"','""')}"` : s;
  }).join(",")).join("\n");
  downloadFile(`${String(currentPatient).replace(/[^a-z0-9_-]+/gi,"_")}_logs.csv`, csv, "text/csv;charset=utf-8");
}

/* =========================
   Init
========================= */
function init(){
  checkStorage();
  loadStore();

  document.getElementById("shiftSelect").value = currentShift;
  document.getElementById("shiftPill").textContent = `Shift: ${currentShift === "day" ? "Day" : "Night"}`;

  rebuildPatientSelect();
  rebuildRNSelects();
  buildRNFilterOptions();
  renderSidebar();
  renderHourly();

  document.getElementById("sortModeLabel").textContent = (sortMode === "room") ? "Room" : "Name";

  if(currentPatient && patients[currentPatient]){
    document.getElementById("patientSelect").value = currentPatient;
    loadPatient(true);
  } else {
    updateHeaderMeta();
    document.getElementById("mainSection").classList.add("hidden");
  }

  // refresh next-due every minute
  setInterval(() => { renderSidebar(); if(!document.getElementById("hourly").classList.contains("hidden")) renderHourly(); }, 60 * 1000);

  showTab("care");
}
init();
</script>

<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js").catch(console.error);
    });
  }
</script>
</body>
</html>
